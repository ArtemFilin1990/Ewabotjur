# Ewabotjur Project Final Instructions (version 64d3546)

This document summarizes the final, working state of the Ewabotjur project, including the
file structure, database schema, environment variables, and deployment instructions for
running in the Amvera cloud environment.

## 1. Final Repository Structure

To run on Amvera, remove all Node.js-related files (`*.js`, `package.json`, `node_modules`).
Only Python files should remain. The cleaned structure should look like this:

```
Ewabotjur/
├── amvera.yml              # Amvera deployment config (Python 3.11)
├── requirements.txt        # Python dependencies (FastAPI, SQLAlchemy, asyncpg)
├── prompts/
│   └── inn_score.md        # System prompt for GPT
├── src/
│   ├── main.py             # Entry point with FastAPI and webhooks
│   ├── config.py           # Configuration/validation logic
│   ├── handlers/           # Telegram/Bitrix24 handlers
│   ├── integrations/       # API clients for DaData, OpenAI, Bitrix24
│   ├── storage/            # PostgreSQL layer (SQLAlchemy models)
│   └── utils/              # Logging, HTTP client, INN parser
└── tests/                  # Python unit tests
```

## 2. PostgreSQL Database Schema

The application automatically creates the schema on the first run via `ensure_schema`. To
pre-create it manually (optional), run:

```sql
CREATE TABLE IF NOT EXISTS bitrix_tokens (
    id SERIAL PRIMARY KEY,
    access_token TEXT NOT NULL,
    refresh_token TEXT NOT NULL,
    expires_in INTEGER NOT NULL,
    domain TEXT NOT NULL,
    saved_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

This table stores Bitrix24 OAuth tokens. Saving tokens in the database ensures persistence
across restarts.

## 3. Environment Variables for Amvera

Set the following variables in Amvera’s Variables section. Replace placeholder values with
your own credentials:

| Variable | Example Value (description) |
| --- | --- |
| `DATABASE_URL` | `postgresql+asyncpg://<user>:<password>@<host>:5432/<db>` |
| `APP_URL` | `https://<app-host>.amvera.io` |
| `PORT` | `3000` |
| `TELEGRAM_BOT_TOKEN` | Telegram bot token from @BotFather |
| `TG_WEBHOOK_SECRET` | Random secret string to secure Telegram webhook |
| `OPENAI_API_KEY` | OpenAI API key |
| `DADATA_API_KEY` | DaData API key |
| `DADATA_SECRET_KEY` | DaData secret key |
| `BITRIX_DOMAIN` | `https://<your-domain>.bitrix24.ru` |
| `BITRIX_CLIENT_ID` | Client ID from Bitrix24 settings |
| `BITRIX_CLIENT_SECRET` | Client secret from Bitrix24 settings |
| `BITRIX_REDIRECT_URL` | `https://<app-host>.amvera.io/oauth/bitrix/callback` |

These environment variables configure database connectivity, application URL, tokens, and
integration credentials.

## 4. Production Deployment Steps

1. Redeploy the application:
   1. In Amvera’s panel, click **Rebuild** to redeploy. The system installs dependencies
      from `requirements.txt` and runs the server using `uvicorn`.
2. Set up Telegram webhook:
   1. Run the following command (replace placeholders with your bot token and webhook
      secret):
      ```bash
      curl -X POST "https://api.telegram.org/bot<TOKEN>/setWebhook?url=https://<app-host>.amvera.io/webhook/telegram/<SECRET>&secret_token=<SECRET>"
      ```
3. Activate Bitrix24 integration:
   1. In your Bitrix24 application settings, set the Redirect URI to:
      `https://<app-host>.amvera.io/oauth/bitrix/callback`.
   2. Open in a browser: `https://<app-host>.amvera.io/oauth/bitrix` and authorize the bot.
      The OAuth tokens will be stored in the `bitrix_tokens` table.
4. Validate deployment:
   1. Visit the health endpoint: `https://<app-host>.amvera.io/health`. It should return
      `{"status": "ok"}`.
   2. Send a company INN (tax number) to your Telegram bot. The bot should return a risk
      analysis generated by GPT using data from DaData.

### Benefits of this setup

- **Persistence**: Bitrix24 tokens are stored in PostgreSQL so they survive container
  restarts.
- **Security**: Webhooks use secret tokens; sensitive keys are not stored in the code but in
  environment variables.
- **Performance**: The application uses asynchronous HTTP pooling for better throughput.
- **Accuracy**: The GPT-based risk analysis strictly follows the system prompt and uses
  verified data from DaData.

## 5. Migration to Python/FastAPI

This final version replaces the original Node.js implementation with Python + FastAPI,
enabling easier development and robust asynchronous I/O. The project now uses:

- FastAPI for the web server and endpoints.
- SQLAlchemy with asyncpg for asynchronous PostgreSQL access.
- HTTPX (or similar) for asynchronous HTTP calls.
- Uvicorn as the ASGI server.

All handlers, utilities, and integrations are implemented in Python, following a modular
architecture with separate packages for handlers, integrations, storage, and utilities.

## 6. Additional Notes

- Ensure that you remove all Node.js files before deploying to avoid unnecessary
  dependencies.
- The `prompts/inn_score.md` file contains the system prompt used for analyzing INNs (tax
  IDs). Modify this file if you need to adjust the analysis.
- Unit tests in the `tests/` directory help verify functionality.
