# Issue Pack: Telegram Bot «Юрист»

Этот пакет задач разбивает разработку Telegram‑бота «Юрист» на эпики и конкретные задачи с критериями готовности (DoD) и приоритетом. Используйте его для создания GitHub Issues или планирования спринтов.

## Эпик 1: Project Setup and Structure

- **Задача 1.1 – Инициализация репозитория**  
  Создайте скелет проекта в соответствии со структурой, описанной в SRS (`src/bot`, `src/router`, `src/prompts/canonical`, `src/files`, `src/llm`, `src/integrations`, `src/storage`, `src/db`, `src/domain`). Добавьте `.gitignore`, пример `.env.example` и краткое описание в `README.md`.  
  **DoD:** каталог проекта соответствует описанию; ненужные файлы игнорируются; в README есть краткое описание и инструкции по установке.  
  **Приоритет:** P0 (критично).

- **Задача 1.2 – Конфигурация сборки и линтинга**  
  Настройте базовые скрипты сборки (npm/yarn или Poetry/pip), линтеры (например ESLint/Prettier или flake8), а также GitHub Actions для автоматической проверки.  
  **DoD:** Workflow CI запускается на каждом push, проверяет форматирование и тесты; сборка проходит без ошибок.  
  **Приоритет:** P1.

- **Задача 1.3 – Документация SRS**  
  Подготовьте файл `docs/SRS.md`, включив в него полное ТЗ, данное пользователем, ссылки на схемы DTO и описание роутера.  
  **DoD:** файл доступен в репозитории и оформлен в формате Markdown.  
  **Приоритет:** P0.

## Эпик 2: Prompt Router

- **Задача 2.1 – Реализация rule‑based роутера**  
  Реализуйте функцию `prompt_router` в `src/router/prompt_router.ts`, которая принимает пользовательский ввод и возвращает объект `RouteDecision` согласно SRS. Учтите hard gates, scoring, пороги доверия, next_action и fill_map.  
  **DoD:** для всех 9 сценариев роутер выбирает корректный промт и выдаёт верные вопросы/действия на тестовых данных; покрытие unit‑тестами ≥ 80%.  
  **Приоритет:** P0.

- **Задача 2.2 – Определение правил и регэкспов**  
  Создайте `src/router/rules.ts` со словарями ключевых слов, регулярными выражениями и приоритетами, описанными в SRS, включая hard gates, конфликты и обработку неоднозначностей.  
  **DoD:** модуль экспортирует все правила; роутер корректно применяет их; unit‑тесты покрывают основные случаи.  
  **Приоритет:** P0.

- **Задача 2.3 – Алгоритм confidence**  
  Реализуйте функцию подсчёта уверенности (confidence) на основе сигналов, бонусов и штрафов; добавьте журнал причин и fired rules в `RouteDecision`.  
  **DoD:** confidence нормализуется в диапазон 0–1; пороговые условия работают согласно SRS; логируются используемые ключевые слова и правила.  
  **Приоритет:** P1.

## Эпик 3: Data Transfer Objects (DTO) и схемы

- **Задача 3.1 – Определить типы и интерфейсы**  
  В `src/domain/types.ts` опишите интерфейсы `RouteDecision`, `SessionContext`, `DocumentArtifact` и `OutputArtifact` согласно JSON‑схемам.  
  **DoD:** TypeScript‑интерфейсы/классы соответствуют схемам; доступны для импорта во всех модулях; типы проходят проверку компилятором.  
  **Приоритет:** P0.

- **Задача 3.2 – Валидаторы данных**  
  Реализуйте функции проверки данных для каждого DTO (например с использованием `zod` или `class‑validator`), чтобы гарантировать корректность входных и выходных данных.  
  **DoD:** валидаторы выбрасывают ошибки при несоответствии схемам; покрыты unit‑тестами; используются в маршрутизаторе и экспортёрах.  
  **Приоритет:** P2.

## Эпик 4: File Intake and Text Extraction

- **Задача 4.1 – Приём входных файлов**  
  Создайте модуль `src/files/intake.ts`, который принимает и валидацию файлов (PDF, DOCX, TXT, MD, изображения при OCR). Проверьте размер и MIME‑тип, сохраните файл в хранилище.  
  **DoD:** неприемлемые форматы или превышение лимита корректно отклоняются; валидный файл сохраняется и возвращается идентификатор `DocumentArtifact`.  
  **Приоритет:** P0.

- **Задача 4.2 – Извлечение текста из файлов**  
  Реализуйте модули для извлечения текста: `pdf.ts`, `docx.ts`, `image_ocr.ts`. Используйте существующие библиотеки (pdfjs, mammoth, Tesseract OCR при включении).  
  **DoD:** текст корректно извлекается из PDF/DOCX; сканы без текстового слоя помечаются статусом `NEEDS_OCR`; модуль возвращает объект `DocumentArtifact` с полями extraction.  
  **Приоритет:** P1.

- **Задача 4.3 – Ограничение объёма вставки в LLM**  
  Добавьте функцию, которая нарезает и выбирает фрагменты из `extracted_text` (до 8000 символов), включая ключевые разделы (оплата, сроки, ответственность), как описано в SRS.  
  **DoD:** для больших документов функция возвращает сокращённый текст; покрыта тестами; отмечается в OutputArtifact поле `assumptions`/`limits`.  
  **Приоритет:** P2.

## Эпик 5: LLM Integration

- **Задача 5.1 – Клиент LLM**  
  Создайте `src/llm/client.ts`, обёртку над выбранным API LLM. Поддержите таймауты, ретраи и передачу системного и пользовательского промта.  
  **DoD:** функция `callLLM(prompt): Promise<string>` корректно возвращает ответ или бросает обработанное исключение; логирует задержку и ошибки.  
  **Приоритет:** P0.

- **Задача 5.2 – Сбор и компоновка промтов**  
  Реализуйте `src/llm/compose.ts`, который собирает канонический промт, подставляет значения из `fill_map`, добавляет извлечённый текст и передаёт в LLM.  
  **DoD:** формат промта соответствует эталону; переменные подставляются правильно; макс. длина не превышена; покрытие тестами.  
  **Приоритет:** P1.

## Эпик 6: Exporters (MD/DOCX/XLSX)

- **Задача 6.1 – Экспорт Markdown**  
  Реализуйте модуль для генерации Markdown из ответа LLM: добавление front matter, краткого резюме, основного контента, блока «Что проверить» и `ASSUMPTIONS`.  
  **DoD:** MD‑файл соответствует шаблону; заголовки и списки форматируются корректно; функция возвращает объект для загрузки.  
  **Приоритет:** P1.

- **Задача 6.2 – Экспорт DOCX**  
  Реализуйте генерацию DOCX (при помощи `python-docx` или `docx.js`), включая титульную страницу, разделы, таблицы и блок «Что проверить».  
  **DoD:** файл открывается в Word без ошибок; стиль соответствует требованиям; тесты для всех сценариев.  
  **Приоритет:** P1.

- **Задача 6.3 – Экспорт XLSX**  
  Реализуйте генерацию таблиц для сценариев RISK_TABLE, DISPUTE_PREP и CASELAW_ANALYTICS. Используйте `openpyxl`/`xlsxwriter` или аналог. Добавьте лист `Meta` с метаданными.  
  **DoD:** таблицы содержат все колонки; автофильтр и заморозка первой строки; файлы открываются без ошибок; покрытие тестами.  
  **Приоритет:** P1.

## Эпик 7: Session Management and Storage

- **Задача 7.1 – Реализация SessionContext**  
  Реализуйте хранилище сеансов (например, Postgres/SQLite + ORM). Модуль `src/domain/session.ts` должен сохранять и загружать контекст пользователя (факты, артефакты, решения роутера), поддерживать TTL и очистку.  
  **DoD:** API предоставляет функции создать/обновить/удалить сессии; TTL применяется; /memory_show и /memory_clear работают.  
  **Приоритет:** P1.

- **Задача 7.2 – Хранение файлов**  
  Настройте S3‑совместимое хранилище или локальный каталог `blobs`; обеспечьте загрузку и получение ссылок для входных и выходных файлов.  
  **DoD:** файлы загружаются и доступны по временным ссылкам; размер и MIME‑тип проверяются; ошибки корректно обрабатываются.  
  **Приоритет:** P1.

## Эпик 8: Commands and UI

- **Задача 8.1 – Реализация команд Telegram**  
  Реализуйте обработку `/start`, `/help`, `/mode`, `/prompts`, `/status`, `/memory_show`, `/memory_clear`, `/admin` в `src/bot/commands.ts`. Каждая команда должна отправлять ответы и отображать клавиатуры согласно UI Copy.  
  **DoD:** команды работают; клавиатуры отображаются; переключение режимов (`message`/`file`/`auto`) сохраняется в контексте.  
  **Приоритет:** P0.

- **Задача 8.2 – Inline‑кнопки и fallback**  
  Реализуйте клавиатуры выбора сценария при низкой уверенности роутера, кнопки «Сделать файлом/короче/подробнее» в ответах и обработку callback query.  
  **DoD:** нажатие кнопок корректно влияет на поведение бота; состояние сохраняется; пользователь получает подтверждение.  
  **Приоритет:** P1.

- **Задача 8.3 – Интернационализация (RU/EN)**  
  Добавьте поддержку локализации сообщений на английском языке; определяйте язык пользователя по настройкам Telegram и сохраняйте в профиле.  
  **DoD:** все команды и ответы доступны на RU и EN; тесты покрывают переключение языка.  
  **Приоритет:** P3.

## Эпик 9: DaData Integration and Scoring

- **Задача 9.1 – Клиент DaData**  
  Реализуйте модуль `src/integrations/dadata.ts` для запроса реквизитов по ИНН/ОГРН/названию. Учтите ключи API и кэширование результатов.  
  **DoD:** успешный запрос возвращает карточку компании; при ошибке корректно обрабатывается таймаут/пустой ответ; кэш работает.  
  **Приоритет:** P1.

- **Задача 9.2 – Скоринг контрагентов**  
  Создайте `src/integrations/scoring.ts`, который на основе полей DaData (статус, недостоверность, массовый адрес) вычисляет уровень риска и формирует список причин.  
  **DoD:** скоринг возвращает категории «Низкий/Средний/Высокий» и причины; корректно обрабатывает отсутствие данных; покрыт тестами.  
  **Приоритет:** P2.

## Эпик 10: Logging, Metrics and Health

- **Задача 10.1 – Логирование и корреляция**  
  Реализуйте централизованное логирование: записывайте `correlation_id`, `route`, `confidence`, `next_action`, `latency`, `error_code` в stdout или систему логов.  
  **DoD:** для каждого запроса формируется уникальный correlation_id; логи содержат минимальные персональные данные; тесты покрывают генерацию ID.  
  **Приоритет:** P2.

- **Задача 10.2 – Метрики и health‑checks**  
  Реализуйте эндпоинт `/health` и сбор метрик (`success_rate`, `avg_latency`, `router_confidence`, `file_fail_rate`, `dadata_fail_rate`).  
  **DoD:** health‑check возвращает статус подключений (DB, storage, DaData, LLM); метрики публикуются (например через Prometheus).  
  **Приоритет:** P3.

## Эпик 11: Testing

- **Задача 11.1 – Unit‑тесты для роутера и DTO**  
  Напишите unit‑тесты для всех функций роутера, правил, расчёта confidence и DTO валидаторов.  
  **DoD:** покрытие не менее 80%; тесты проходят в CI.  
  **Приоритет:** P0.

- **Задача 11.2 – Интеграционные тесты**  
  Разработайте сценарии для проверки end‑to‑end: запрос → уточнения → генерация → экспорт → отправка файла; учтите все 9 промтов и DaData.  
  **DoD:** тесты запускаются в CI; сценарии завершаются без ошибок; проверяется корректность файлов.  
  **Приоритет:** P1.

- **Задача 11.3 – Нагрузочное тестирование**  
  Оцените производительность бота при одновременных обращениях: измерьте время ответа на текст/файл, задержки LLM, лимиты по размеру.  
  **DoD:** сформирован отчёт; определены узкие места и предложены оптимизации; результаты доступны команде.  
  **Приоритет:** P4.

## Эпик 12: Deployment and Operations

- **Задача 12.1 – Конфигурация деплоя**  
  Подготовьте скрипты развертывания (Dockerfile, docker‑compose) и инструкции по запуску в выбранной среде (Vercel, Render, VPS).  
  **DoD:** приложение разворачивается одной командой; переменные окружения корректно считываются; хранилище и база данных подключаются.  
  **Приоритет:** P2.

- **Задача 12.2 – Очереди и дедупликация**  
  При необходимости добавьте очередь задач для тяжёлых операций (например OCR) и механизм дедупликации апдейтов Telegram.  
  **DoD:** долгие операции обрабатываются асинхронно; дубликаты апдейтов не приводят к повторной обработке; включены ретраи.  
  **Приоритет:** P4.

- **Задача 12.3 – Управление ключами и безопасностью**  
  Настройте безопасное хранение ключей (env, secrets manager), контроль доступа к хранилищу и базе, а также политику TTL для данных и артефактов.  
  **DoD:** секреты не хранятся в репозитории; доступ ограничен; проведён аудит безопасности; задокументированы политики удаления данных.  
  **Приоритет:** P3.
