# Ewabotjur

Telegram + Bitrix24 ะฑะพั ะดะปั ะฐะฝะฐะปะธะทะฐ ะบะพะฝััะฐะณะตะฝัะพะฒ ะฟะพ ะะะ ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ DaData ะธ GPT.

## ๐ฏ ะะพะทะผะพะถะฝะพััะธ

- โ ะะพะปััะตะฝะธะต ะดะฐะฝะฝัั ะพ ะบะพะผะฟะฐะฝะธัั ะฟะพ ะะะ ัะตัะตะท DaData API
- โ ะะฝะฐะปะธะท ัะธัะบะพะฒ ะธ ัะตะบะพะผะตะฝะดะฐัะธะธ ัะตัะตะท OpenAI GPT
- โ ะะฝัะตะณัะฐัะธั ั Telegram (webhook)
- โ ะะฝัะตะณัะฐัะธั ั Bitrix24 imbot (OAuth 2.0 ั auto-refresh)
- โ ะะพัะพะฒัะน ะบ ะดะตะฟะปะพั ะฝะฐ Amvera

## ๐๏ธ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโ       โโโโโโโโโโโโโโโโ
โ  Telegram   โโโโโโโโถโ   FastAPI    โ
โ   Webhook   โ       โ  Application โ
โโโโโโโโโโโโโโโ       โโโโโโโโฌโโโโโโโโ
                             โ
โโโโโโโโโโโโโโโ              โ
โ  Bitrix24   โโโโโโโโโโโโโโโโค
โ   Webhook   โ              โ
โโโโโโโโโโโโโโโ              โ
                             โ
                    โโโโโโโโโโผโโโโโโโโโ
                    โ   INN Parser    โ
                    โโโโโโโโโโฌโโโโโโโโโ
                             โ
                    โโโโโโโโโโผโโโโโโโโโ
                    โ  DaData API     โ
                    โ  (Company Info) โ
                    โโโโโโโโโโฌโโโโโโโโโ
                             โ
                    โโโโโโโโโโผโโโโโโโโโ
                    โ   OpenAI GPT    โ
                    โ   (Analysis)    โ
                    โโโโโโโโโโฌโโโโโโโโโ
                             โ
                    โโโโโโโโโโผโโโโโโโโโ
                    โ  Response to    โ
                    โ Telegram/Bitrix โ
                    โโโโโโโโโโโโโโโโโโโ
```

## ๐ ะขัะตะฑะพะฒะฐะฝะธั

- Python 3.11+
- Docker (ะดะปั ะดะตะฟะปะพั)
- API ะบะปััะธ:
  - Telegram Bot Token
  - DaData API Key
  - OpenAI API Key
  - Bitrix24 OAuth credentials

## ๐ ะัััััะน ััะฐัั

### 1. ะะปะพะฝะธัะพะฒะฐะฝะธะต ัะตะฟะพะทะธัะพัะธั

```bash
git clone https://github.com/ArtemFilin1990/Ewabotjur.git
cd Ewabotjur
```

### 2. ะะฐัััะพะนะบะฐ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั

```bash
cp .env.example .env
# ะะฐะฟะพะปะฝะธัะต .env ัะตะฐะปัะฝัะผะธ ะทะฝะฐัะตะฝะธัะผะธ
```

### 3. ะะพะบะฐะปัะฝัะน ะทะฐะฟััะบ

```bash
# ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
pip install -r requirements.txt

# ะะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั
python -m src.main
```

ะัะธะปะพะถะตะฝะธะต ะฑัะดะตั ะดะพัััะฟะฝะพ ะฝะฐ `http://localhost:3000`

### 4. ะฃััะฐะฝะพะฒะบะฐ Telegram webhook

```bash
curl -s "https://api.telegram.org/bot<TELEGRAM_BOT_TOKEN>/setWebhook" \
  -d "url=https://<YOUR_DOMAIN>/webhook/telegram/<TG_WEBHOOK_SECRET>"
```

## ๐ณ ะะตะฟะปะพะน ะฝะฐ Amvera

### ะจะฐะณ 1: ะะพะดะณะพัะพะฒะบะฐ ัะตะฟะพะทะธัะพัะธั

ะคะฐะนะปั ะดะปั Amvera ัะถะต ะณะพัะพะฒั:
- `Dockerfile` โ ะผะฝะพะณะพััะฐะฟะฝะฐั ัะฑะพัะบะฐ Python ะฟัะธะปะพะถะตะฝะธั
- `amvera.yml` โ ะบะพะฝัะธะณััะฐัะธั ั containerPort: 3000

### ะจะฐะณ 2: ะกะพะทะดะฐะฝะธะต ะฟัะธะปะพะถะตะฝะธั ะฒ Amvera

1. ะะตัะตะนะดะธัะต ะฒ UI Amvera
2. Create application
3. Source: GitHub
4. Repo: `ArtemFilin1990/Ewabotjur`
5. Branch: `main`
6. Toolchain: Docker
7. Deploy

### ะจะฐะณ 3: ะะฐัััะพะนะบะฐ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั

ะ ัะฐะทะดะตะปะต "ะะตัะตะผะตะฝะฝัะต" Amvera ะดะพะฑะฐะฒััะต:

**ะะฑัะทะฐัะตะปัะฝัะต:**
- `TELEGRAM_BOT_TOKEN` โ ัะพะบะตะฝ ะพั @BotFather
- `TG_WEBHOOK_SECRET` โ ัะปััะฐะนะฝะฐั ัััะพะบะฐ ะดะปั ะฑะตะทะพะฟะฐัะฝะพััะธ
- `DADATA_API_KEY` โ ะบะปัั DaData
- `DADATA_SECRET_KEY` โ ัะตะบัะตัะฝัะน ะบะปัั DaData
- `OPENAI_API_KEY` โ ะบะปัั OpenAI
- `BITRIX_DOMAIN` โ ะดะพะผะตะฝ Bitrix24 (https://xxx.bitrix24.ru)
- `BITRIX_CLIENT_ID` โ Client ID ะฟัะธะปะพะถะตะฝะธั Bitrix24
- `BITRIX_CLIENT_SECRET` โ Client Secret ะฟัะธะปะพะถะตะฝะธั Bitrix24
- `BITRIX_REDIRECT_URL` โ URL callback (https://your-app.amvera.app/oauth/bitrix/callback)

**ะะฟัะธะพะฝะฐะปัะฝัะต:**
- `APP_URL` โ URL ะฒะฐัะตะณะพ ะฟัะธะปะพะถะตะฝะธั ะฝะฐ Amvera
- `LOG_LEVEL` โ ััะพะฒะตะฝั ะปะพะณะธัะพะฒะฐะฝะธั (INFO, DEBUG, WARNING, ERROR)
- `OPENAI_MODEL` โ ะผะพะดะตะปั GPT (ะฟะพ ัะผะพะปัะฐะฝะธั gpt-4)
- `USE_MCP` โ ะธัะฟะพะปัะทะพะฒะฐัั MCP (true/false)
- `MCP_SERVER_URL` โ URL MCP ัะตัะฒะตัะฐ
- `MCP_API_KEY` โ ะบะปัั MCP

ะะพัะปะต ะธะทะผะตะฝะตะฝะธั ะฟะตัะตะผะตะฝะฝัั ะฟะตัะตะทะฐะฟัััะธัะต ะบะพะฝัะตะนะฝะตั.

### ะจะฐะณ 4: ะฃััะฐะฝะพะฒะบะฐ webhook

ะะพัะปะต ะดะตะฟะปะพั ั ะฒะฐั ะฑัะดะตั URL: `https://<app>.amvera.app`

ะฃััะฐะฝะพะฒะธัะต Telegram webhook:

```bash
curl -s "https://api.telegram.org/bot<TELEGRAM_BOT_TOKEN>/setWebhook" \
  -d "url=https://<app>.amvera.app/webhook/telegram/<TG_WEBHOOK_SECRET>"
```

### ะจะฐะณ 5: ะะฐัััะพะนะบะฐ Bitrix24 OAuth

1. ะ Bitrix24 ัะพะทะดะฐะนัะต ะฟัะธะปะพะถะตะฝะธะต ัะธะฟะฐ "ะะพะบะฐะปัะฝะพะต ะฟัะธะปะพะถะตะฝะธะต"
2. ะฃะบะฐะถะธัะต redirect URL: `https://<app>.amvera.app/oauth/bitrix/callback`
3. ะะพะปััะธัะต Client ID ะธ Client Secret
4. ะะพะฑะฐะฒััะต ะธั ะฒ ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั Amvera
5. ะะตัะตะนะดะธัะต ะฟะพ ะฐะดัะตัั: `https://<app>.amvera.app/oauth/bitrix/start`
6. ะัะพะนะดะธัะต ะฐะฒัะพัะธะทะฐัะธั
7. ะขะพะบะตะฝั ัะพััะฐะฝัััั ะฒ `storage/bitrix_tokens.json`

## ๐ API Endpoints

### Health Check
```
GET /health
```

ะัะฒะตั:
```json
{
  "status": "healthy",
  "has_telegram_token": true,
  "has_dadata_key": true,
  "has_openai_key": true,
  "has_bitrix_config": true
}
```

### Telegram Webhook
```
POST /webhook/telegram/{secret}
```

ะัะธะฝะธะผะฐะตั update ะพั Telegram.

### Bitrix24 Webhook
```
POST /webhook/bitrix
```

ะัะธะฝะธะผะฐะตั ัะพะฑััะธั ะพั Bitrix24 imbot.

### Bitrix24 OAuth

**ะะฝะธัะธะฐัะธั:**
```
GET /oauth/bitrix/start
```

**Callback:**
```
GET /oauth/bitrix/callback?code=...
```

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

```bash
# ะะฐะฟััะบ ัะตััะพะฒ
python -m unittest discover tests

# ะะพะฝะบัะตัะฝัะน ัะตัั
python -m unittest tests.test_inn_parser
```

## โ๏ธ ะะฐะถะฝัะต ะทะฐะผะตัะฐะฝะธั

### ะฅัะฐะฝะตะฝะธะต ัะพะบะตะฝะพะฒ Bitrix24

ะขะพะบะตะฝั OAuth ััะฐะฝัััั ะฒ ัะฐะนะปะต `storage/bitrix_tokens.json`. ะ Docker ะบะพะฝัะตะนะฝะตัะต:

- **ะัะพะฑะปะตะผะฐ**: ะัะธ ะฟะตัะตะทะฐะฟััะบะต ะบะพะฝัะตะนะฝะตัะฐ ัะพะบะตะฝั ัะตัััััั
- **ะะตัะตะฝะธะต ะดะปั ะฟัะพะดะฐะบัะตะฝะฐ**:
  1. ะะฐัััะพะนัะต persistent volume ะดะปั `/app/storage` ะฒ Amvera
  2. ะัะฟะพะปัะทัะนัะต ะฒะฝะตัะฝะตะต ััะฐะฝะธะปะธัะต (PostgreSQL, Redis)
  3. ะะปะธ ะฟะพะฒัะพัะฝะพ ะฟัะพัะพะดะธัะต OAuth ะฟะพัะปะต ะบะฐะถะดะพะณะพ ะดะตะฟะปะพั

### ะะพัั ะฟัะธะปะพะถะตะฝะธั

ะัะธะปะพะถะตะฝะธะต **ะะะฏะะะขะะะฌะะ** ะดะพะปะถะฝะพ ัะปััะฐัั ะฟะพัั ะธะท ะฟะตัะตะผะตะฝะฝะพะน ะพะบััะถะตะฝะธั `PORT`:
- ะะพ ัะผะพะปัะฐะฝะธั: 3000
- Amvera ะฐะฒัะพะผะฐัะธัะตัะบะธ ัััะฐะฝะฐะฒะปะธะฒะฐะตั ะฟัะฐะฒะธะปัะฝะพะต ะทะฝะฐัะตะฝะธะต
- ะ `amvera.yml` ัะบะฐะทะฐะฝ `containerPort: 3000`

## ๐ ะะพะณะธัะพะฒะฐะฝะธะต

ะัะธะปะพะถะตะฝะธะต ะธัะฟะพะปัะทัะตั ััััะบัััะธัะพะฒะฐะฝะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต:
- ะฃัะพะฒะตะฝั ะทะฐะดะฐัััั ัะตัะตะท `LOG_LEVEL`
- ะะพะณะธ ะฝะต ัะพะดะตัะถะฐั ัะพะบะตะฝั ะธ ัะตะบัะตัั (ัะพะปัะบะพ `has_token: true/false`)
- ะคะพัะผะฐั: `%(asctime)s - %(name)s - %(levelname)s - %(message)s`

## ๐ ะะตะทะพะฟะฐัะฝะพััั

- โ ะะธะบะพะณะดะฐ ะฝะต ะบะพะผะผะธัััะต ัะตะบัะตัั ะฒ ัะตะฟะพะทะธัะพัะธะน
- โ ะัะต ัะตะบัะตัั ัะตัะตะท ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
- โ Webhook Telegram ะทะฐัะธััะฝ ัะตะบัะตัะฝัะผ ะบะปััะพะผ
- โ Bitrix24 OAuth ั refresh token
- โ ะะพะณะธ ะฝะต ัะพะดะตัะถะฐั ััะฒััะฒะธัะตะปัะฝัั ะดะฐะฝะฝัั

## ๐ค ะัะธะฝัะธะฟั ัะฐะฑะพัั ั GPT

**ะะฐะถะฝะพ:** GPT ัะพัะผะธััะตั ะขะะะฌะะ ะฒัะฒะพะดั ะธ ัะตะบะพะผะตะฝะดะฐัะธะธ. ะัะต ัะฐะบัั ะฑะตััััั ะขะะะฌะะ ะธะท DaData.

GPT ะะ ะดะพะปะถะตะฝ:
- โ ะัะธะดัะผัะฒะฐัั ัะธะฝะฐะฝัะพะฒัะต ะฟะพะบะฐะทะฐัะตะปะธ
- โ ะะตะปะฐัั ะฒัะฒะพะดั ะพ ัะพะผ, ะพ ััะผ ะฝะตั ะดะฐะฝะฝัั
- โ ะะฐะฒะฐัั ััะธะดะธัะตัะบะธะต ะทะฐะบะปััะตะฝะธั

GPT ะดะพะปะถะตะฝ:
- โ ะะฝะฐะปะธะทะธัะพะฒะฐัั ะธะผะตััะธะตัั ะดะฐะฝะฝัะต
- โ ะััะฒะปััั ัะธัะบะธ ะฝะฐ ะพัะฝะพะฒะต ัะฐะบัะพะฒ
- โ ะะตะบะพะผะตะฝะดะพะฒะฐัั ะดะพะบัะผะตะฝัั ะดะปั ะทะฐะฟัะพัะฐ
- โ ะะฐะฒะฐัั ะฟัะฐะบัะธัะตัะบะธะต ัะพะฒะตัั

ะกะธััะตะผะฝัะน ะฟัะพะผะฟั ะฝะฐัะพะดะธััั ะฒ `prompts/inn_score.md`.

## ๐๏ธ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
Ewabotjur/
โโโ Dockerfile              # Docker ะพะฑัะฐะท ะดะปั Amvera
โโโ amvera.yml             # ะะพะฝัะธะณััะฐัะธั Amvera
โโโ requirements.txt       # Python ะทะฐะฒะธัะธะผะพััะธ
โโโ .env.example          # ะัะธะผะตั ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
โโโ README.md             # ะะพะบัะผะตะฝัะฐัะธั
โโโ src/
โ   โโโ main.py          # ะขะพัะบะฐ ะฒัะพะดะฐ FastAPI
โ   โโโ config.py        # ะะพะฝัะธะณััะฐัะธั ะธะท env
โ   โโโ integrations/    # ะะฝัะตะณัะฐัะธะธ ั ะฒะฝะตัะฝะธะผะธ API
โ   โ   โโโ telegram.py
โ   โ   โโโ dadata.py
โ   โ   โโโ openai_client.py
โ   โ   โโโ bitrix24/
โ   โ       โโโ oauth.py    # OAuth 2.0 ั auto-refresh
โ   โ       โโโ api.py      # Bitrix24 REST API
โ   โโโ handlers/        # ะะฑัะฐะฑะพััะธะบะธ ัะพะฑััะธะน
โ   โ   โโโ telegram_handler.py
โ   โ   โโโ bitrix_handler.py
โ   โโโ utils/          # ะฃัะธะปะธัั
โ       โโโ inn_parser.py   # ะะฐััะธะฝะณ ะะะ
โโโ prompts/
โ   โโโ inn_score.md    # ะกะธััะตะผะฝัะน ะฟัะพะผะฟั ะดะปั GPT
โโโ tests/              # ะขะตััั
```

## ๐ ะะพะดะดะตัะถะบะฐ

ะัะธ ะฒะพะทะฝะธะบะฝะพะฒะตะฝะธะธ ะฟัะพะฑะปะตะผ:
1. ะัะพะฒะตัััะต ะปะพะณะธ ะฟัะธะปะพะถะตะฝะธั
2. ะฃะฑะตะดะธัะตัั, ััะพ ะฒัะต ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ัััะฐะฝะพะฒะปะตะฝั
3. ะัะพะฒะตัััะต ะฒะฐะปะธะดะฝะพััั API ะบะปััะตะน
4. ะฃะฑะตะดะธัะตัั, ััะพ webhook ัััะฐะฝะพะฒะปะตะฝ ะฟัะฐะฒะธะปัะฝะพ

## ๐ ะะธัะตะฝะทะธั

MIT License

## ๐ ะะปะฐะณะพะดะฐัะฝะพััะธ

- [FastAPI](https://fastapi.tiangolo.com/) โ ะฒะตะฑ-ััะตะนะผะฒะพัะบ
- [DaData](https://dadata.ru/) โ ะดะฐะฝะฝัะต ะพ ะบะพะผะฟะฐะฝะธัั
- [OpenAI](https://openai.com/) โ GPT ะดะปั ะฐะฝะฐะปะธะทะฐ
- [Telegram Bot API](https://core.telegram.org/bots/api) โ Telegram ะธะฝัะตะณัะฐัะธั
- [Bitrix24](https://dev.bitrix24.ru/) โ Bitrix24 REST API
